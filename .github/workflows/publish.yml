# Publish to Modrinth, CurseForge, GitHub Releases, and Maven.
name: publish
on: [ workflow_dispatch ]

jobs:
    build:
        strategy:
            matrix:
                java: [ 17 ]
        runs-on: ubuntu-latest
        env:
            MAVEN_USER: ${{ secrets.MAVEN_USER }}
            MAVEN_PASS: ${{ secrets.MAVEN_PASS }}
        steps:

            - name: checkout repository
              uses: actions/checkout@v2

            - name: setup jdk ${{ matrix.java }}
              uses: actions/setup-java@v1
              with:
                  java-version: ${{ matrix.java }}

            - uses: actions/cache@v2
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/loom-cache
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
                  restore-keys: ${{ runner.os }}-gradle

            - name: make gradle wrapper executable
              run: chmod +x ./gradlew

            - name: build and publish to maven
              run: ./gradlew build #OrPublish

            - name: capture build artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: Artifacts
                  path: build/libs/

            - name: prepare changelog for publish
              run: ./gradlew prepareChangelog

            - name: publish to Modrinth, CurseForge, and GitHub Releases
              uses: Kir-Antipov/mc-publish@v3.2
              with:
                  modrinth-id: h06RZwls # testing project ID
                  modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
                  modrinth-featured: true

#                  curseforge-id: 624165
#                  curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

#                  github-token: ${{ secrets.GITHUB_TOKEN }}

                  loaders: |
                      fabric
                      quilt
                  version-type: beta

                  changelog-file: CHANGELOG.txt
